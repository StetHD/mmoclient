package ui{	import flash.ui.Mouse;	import flash.display.MovieClip;	import flash.text.TextField;	import fl.text.TLFTextField;	import flash.display.DisplayObjectContainer;	import flash.events.MouseEvent;	import flash.display.DisplayObject;	import Main;	import game.Game;	import game.map.Tile;	import game.entity.Entity;	import game.entity.Army;	import game.entity.City;	import game.entity.Improvement;		import net.Connection;	import net.packet.InfoArmy;		import net.packet.InfoGenericArmy;	import net.packet.InfoCity;	import net.packet.InfoKingdom;	import net.packet.InfoTile;		import ui.events.MainUIEvents;	import ui.events.ClaimClickEvent;	import ui.events.ShowCityUIEvent;	import ui.events.TileBuildClickEvent;	import net.packet.ChatMsg;	import game.perception.PerceptionManager;	import ui.events.GameEvents;		public class MainUI extends MovieClip	{		private static var ICON_X_SPACER:int = 2;		private static var COMMAND_NONE:int = 1;		private static var COMMAND_MOVE:int = 2;		private static var COMMAND_ATTACK:int = 3;		private static var COMMAND_CLAIM:int = 4;		private static var SELECTED_NONE:int = 0;		private static var SELECTED_TILE:int = 1;		private static var SELECTED_ENTITY:int = 2;						private static var INFO:int = 0;		private static var MOVE:int = 1;		private static var ATTACK:int = 2;		private static var CLAIM:int = 3;		private static var BUILD:int = 4;		private static var TRAIN:int = 5;		private static var CRAFT:int = 6;		private static var FORM:int = 7;		public var main:Main;		public var menuText:TextField;		public var empireText:TextField;		public var kingdomText:TextField;		public var warfareText:TextField;		public var arcaneText:TextField;		public var civicsText:TextField;				public var selectedBlockCity:SelectedBlockCity;		public var selectedBlockArmy:SelectedBlockArmy;		public var selectedBlockLand:SelectedBlockLand;				public var button1:ActionButton;		public var button2:ActionButton;		public var button3:ActionButton;		public var button4:ActionButton;		public var button5:ActionButton;					public var button6:ActionButton;		public var targetName:TLFTextField;		public var empireKingdomName:TLFTextField;		public var ratingLabel:TLFTextField;		public var repLabel:TLFTextField;		public var diffLabel:TLFTextField;		public var ratingValue:TLFTextField;		public var repValue:TLFTextField;		public var diffValue:TLFTextField;		public var hpAtkDefLabel:TLFTextField;		public var hpAtkDefValue:TLFTextField;		public var pwrWeaInfLabel:TLFTextField;		public var pwrWeaInfValue:TLFTextField;		public var loyHeaSecLabel:TLFTextField;		public var upkeepLabel:TLFTextField;		public var upkeepValue:TLFTextField;		public var hpLabel:TLFTextField;		public var hpValue:TLFTextField;		public var mpLabel:TLFTextField;		public var mpValue:TLFTextField;		public var mtLabel:TLFTextField;		public var mtValue:TLFTextField;				public var goldText:TLFTextField;		public var totalPopText:TLFTextField;				public var chatInput:TextField;		public var chatLog:TLFTextField;		public var sendMsg:TLFTextField;				public var iconTile:IconTile;		private var selectedType:int;		private var selectedTile:Tile;		private var selectedEntity:Entity;		private var iconEntities/*Entity*/:Array;		private var command:int;		public function MainUI()		{			selectedType = SELECTED_NONE;			command = COMMAND_NONE;		}					public function init(_main:Main)		{						main = _main;			hideActionButtons();			button1.addEventListener(MouseEvent.CLICK, actionButtonClick);			button2.addEventListener(MouseEvent.CLICK, actionButtonClick);			button3.addEventListener(MouseEvent.CLICK, actionButtonClick);			button4.addEventListener(MouseEvent.CLICK, actionButtonClick);			button5.addEventListener(MouseEvent.CLICK, actionButtonClick);			button6.addEventListener(MouseEvent.CLICK, actionButtonClick);			iconTile.visible = false;			iconTile.addEventListener(MouseEvent.CLICK, iconTileClick);						sendMsg.addEventListener(MouseEvent.CLICK, sendMsgClick);			iconEntities = new Array();											Connection.INSTANCE.addEventListener(Connection.onInfoKingdomEvent, infoKingdomEvent);			Connection.INSTANCE.addEventListener(Connection.onReceiveChatMsg, receiveChatMsgEvent);						UIEventDispatcher.INSTANCE.addEventListener(MainUIEvents.ShowCityUIEvent, showCityUIEvent);			UIEventDispatcher.INSTANCE.addEventListener(GameEvents.PerceptionUpdate, perceptionUpdate);		}		public function isMoveCommand():Boolean		{			return command == COMMAND_MOVE;		}		public function isAttackCommand():Boolean		{			return command == COMMAND_ATTACK;		}				public function isClaimCommand():Boolean		{			return command == COMMAND_CLAIM;		}		public function resetCommand():void		{			command = COMMAND_NONE;		}		public function setSelectedTile(tile:Tile):void		{			selectedTile = tile;			removeReticules();			removeIcons();			setTileIcon();			setEntityIcons();		}				public function setTargetBar() : void		{					}				private function perceptionUpdate(e:ParamEvent) : void		{			trace("perceptionUpdate selectedTile: " + Game.INSTANCE.selectedTile);			if(Game.INSTANCE.selectedTile != null)				setSelectedTile(Game.INSTANCE.selectedTile);		}		private function setTileIcon():void		{			iconTile.visible = true;			iconTile.setTile(selectedTile);		}		private function setEntityIcons():void		{			trace("setEntityIcons");			if (selectedTile != null)			{				var iconTileEdgeX:int = iconTile.x + iconTile.width;				trace("selectedTile.entities: " + selectedTile.entities.length);				for (var i:int = 0; i < selectedTile.entities.length; i++)				{					var entity:Entity = Entity(selectedTile.entities[i]);										var iconEntity:IconEntity = new IconEntity();					iconEntity.setEntity(selectedTile.entities[i]);					iconEntity.copyImage(48, 48);					iconEntity.x = iconTileEdgeX + ICON_X_SPACER + i * (iconEntity.width + ICON_X_SPACER);					iconEntity.y = iconTile.y;					iconEntity.addEventListener(MouseEvent.CLICK, iconEntityClick);					iconEntities.push(iconEntity);					addChild(iconEntity);				}			}		}				private function removeReticules() : void		{			main.moveReticule.hide();			main.attackReticule.hide();		}				private function removeIcons():void		{			if(iconEntities != null)			{				for (var i:int = 0; i < iconEntities.length; i++)				{					iconEntities[i].removeEventListener(MouseEvent.CLICK, iconEntityClick);					removeChild(iconEntities[i]);				}					iconEntities.length = 0;			}		}		private function iconTileClick(e:MouseEvent):void		{			var iconTile:IconTile = e.target as IconTile;						hideActivateEntities();				hideSelectedBlocks();						iconTile.showActivate();						selectedType = SELECTED_TILE;			selectedTile = iconTile.tile;			selectedEntity = null;			setActionBar();			showLandTarget();		}		private function iconEntityClick(e:MouseEvent):void		{			var iconEntity:IconEntity = e.target as IconEntity;						hideActivateEntities();						hideSelectedBlocks();			iconTile.hideActivate();						iconEntity.showActivate();									selectedType = SELECTED_ENTITY;			selectedEntity = iconEntity.entity;			selectedTile = null;			setActionBar();						if(selectedEntity.type == Army.TYPE)			{				showArmyTarget();			}			else if(selectedEntity.type == City.TYPE)			{				showCityTarget();			}		}				private function showCityUIEvent(e:ShowCityUIEvent) : void		{			var showCityUIEvent:ShowCityUIEvent = ShowCityUIEvent(e);			var cityTile:Tile = showCityUIEvent.city.tile;						setSelectedTile(cityTile);						hideActivateEntities();					hideSelectedBlocks();			iconTile.hideActivate();						for(var i:int = 0; i < iconEntities.length; i++)			{				var iconEntity:IconEntity = IconEntity(iconEntities[i]);								if(iconEntity.entity.id == showCityUIEvent.city.id)				{					iconEntity.showActivate();				}			}									selectedType = SELECTED_ENTITY;			selectedEntity = showCityUIEvent.city;			selectedTile = null;			setActionBar();						showCityTarget();		}				private function hideActivateEntities() : void		{			if(iconEntities != null)			{				for (var i:int = 0; i < iconEntities.length; i++)				{					iconEntities[i].hideActivate();														}						}					}		private function setActionBar():void		{			hideActionButtons();			if (selectedType == SELECTED_TILE)			{				setActionButton(button1, INFO);				setActionButton(button2, BUILD);   			}			else if (selectedType == SELECTED_ENTITY)			{				setActionButton(button1, INFO);								if (selectedEntity.type == Entity.ARMY)				{										if (selectedEntity.isPlayers())					{						setActionButton(button2, MOVE);						setActionButton(button3, ATTACK);						setActionButton(button4, CLAIM);					}				}				else if (selectedEntity.type == Entity.CITY)				{										if (selectedEntity.isPlayers())					{						setActionButton(button2, BUILD);						setActionButton(button3, TRAIN);						setActionButton(button4, CRAFT);						setActionButton(button5, FORM);					}				}			}		}				private function sendMsgClick(e:MouseEvent) : void		{			var chatMsg:ChatMsg = new ChatMsg();			chatMsg.playerId = Game.INSTANCE.player.id;			chatMsg.playerName = "Peter";			chatMsg.msg = chatInput.text;						var chatPacket:ParamEvent = new ParamEvent(Connection.onSendChatMsg);			chatPacket.params = chatMsg;						Connection.INSTANCE.dispatchEvent(chatPacket);					}		private function hideActionButtons():void		{			button1.visible = false;			button2.visible = false;			button3.visible = false;			button4.visible = false;			button5.visible = false;			button6.visible = false;		}				private function actionButtonClick(e:MouseEvent) : void		{			var actionButton:ActionButton = ActionButton(e.target);						removeReticules();			hideActivateActionButtons();			actionButton.showActivate();						trace("MainUI " + actionButton.actionType);			switch(actionButton.actionType)			{				case INFO:					infoButtonClick();					break;				case MOVE:					moveButtonClick();					break;				case ATTACK:					attackButtonClick();					break;				case CLAIM:					claimButtonClick();					break;				case BUILD:					buildButtonClick();					break;				case TRAIN:					trainButtonClick();					break;				case CRAFT:					craftButtonClick();					break;				case FORM:					formButtonClick();					break;				default:					trace("Invalid action button click");			}		}		private function infoButtonClick():void		{						if (selectedType == SELECTED_TILE)			{				var pEvent:ParamEvent = new ParamEvent(Tile.onDoubleClick);				pEvent.params = selectedTile;				Game.INSTANCE.dispatchEvent(pEvent);							}			else if (selectedType == SELECTED_ENTITY)			{				if (selectedEntity.type == Entity.ARMY)				{					trace("Army selectedEntity.type: " + selectedEntity.type);					var selectedArmy:Army = Army(selectedEntity);					var pEvent:ParamEvent = new ParamEvent(Army.onDoubleClick);					pEvent.params = selectedArmy;					Game.INSTANCE.dispatchEvent(pEvent);				}				else if (selectedEntity.type == Entity.CITY)				{					trace("City selectedEntity.type: " + selectedEntity.type);					var selectedCity:City = City(selectedEntity);					var pEvent:ParamEvent = new ParamEvent(City.onDoubleClick);					pEvent.params = selectedCity;					Game.INSTANCE.dispatchEvent(pEvent);				}							}		}		private function moveButtonClick():void		{			Game.INSTANCE.selectedEntity = selectedEntity;			command = COMMAND_MOVE;						main.moveReticule.show();		}		private function attackButtonClick():void		{			Game.INSTANCE.selectedEntity = selectedEntity;			command = COMMAND_ATTACK;						main.attackReticule.show();		}				private function claimButtonClick() : void		{			Game.INSTANCE.selectedEntity = selectedEntity;			command = COMMAND_CLAIM;						var claimClickEvent:ClaimClickEvent = new ClaimClickEvent(MainUIEvents.ClaimClickEvent);			claimClickEvent.selectedTile = selectedEntity.tile;			claimClickEvent.selectedArmy = Army(selectedEntity);						UIEventDispatcher.INSTANCE.dispatchEvent(claimClickEvent);		}				private function buildButtonClick() : void		{			if(selectedEntity == null)			{				var tileBuildEvent:TileBuildClickEvent = new TileBuildClickEvent(MainUIEvents.TileBuildClickEvent);				tileBuildEvent.tile = selectedTile;								UIEventDispatcher.INSTANCE.dispatchEvent(tileBuildEvent);							}			else			{				var citybuildClickEvent:MouseEvent = new MouseEvent(MainUIEvents.CityBuildClickEvent);				UIEventDispatcher.INSTANCE.dispatchEvent(citybuildClickEvent);			}		}				private function trainButtonClick() : void		{			trace("MainUI - trainButtonClick");						var trainClickEvent:MouseEvent = new MouseEvent(MainUIEvents.TrainClickEvent);									UIEventDispatcher.INSTANCE.dispatchEvent(trainClickEvent);					}				private function craftButtonClick() : void		{									trace("MainUI - craftButtonClick");			if(selectedEntity.type == Entity.CITY)			{				var craftClickEvent:MouseEvent = new MouseEvent(MainUIEvents.CityCraftClickEvent);				UIEventDispatcher.INSTANCE.dispatchEvent(craftClickEvent);								}					}				private function formButtonClick() : void		{									trace("MainUI - formButtonClick");			trace("selectedEntity.type: " + selectedEntity.type + " City: " + Entity.CITY)			if(selectedEntity.type == Entity.CITY)			{				var formClickEvent:MouseEvent = new MouseEvent(MainUIEvents.FormClickEvent);				UIEventDispatcher.INSTANCE.dispatchEvent(formClickEvent);								}					}						private function infoKingdomEvent(e:ParamEvent) : void		{			trace("MainUI - infoKingdomEvent");			var infoKingdom:InfoKingdom = InfoKingdom(e.params);			trace(infoKingdom.gold);									goldText.htmlText = infoKingdom.gold.toString();						trace("goldText.htmlText: " + goldText.htmlText);		}				private function receiveChatMsgEvent(e:ParamEvent) : void		{			trace("MainUI - receiveChatMsgEvent");			var chatMsg:ChatMsg = ChatMsg(e.params);			var line:String = chatMsg.playerName + ": " + chatMsg.msg;						chatLog.htmlText += line;		}				private function showArmyTarget() : void		{			var army:Army = Army(selectedEntity);			selectedBlockArmy.armyName.text = army.getName();			selectedBlockArmy.kingdomName.text = army.getKingdomName();			selectedBlockArmy.setImage(army.getImage());					selectedBlockArmy.visible = true;		}				private function showCityTarget() : void		{			var city:City = City(selectedEntity);			selectedBlockCity.cityName.text = city.getName();			selectedBlockCity.kingdomName.text = "";			selectedBlockCity.setImage(city.getImage());					selectedBlockCity.visible = true;		}				private function showLandTarget() : void		{			selectedBlockLand.tileName.text = Tile.GetTileName(selectedTile.type);			selectedBlockLand.coords.text = "(" + selectedTile.gameX + ", " + selectedTile.gameY + ")";			selectedBlockLand.kingdomName.text = "";			selectedBlockLand.setImage(selectedTile.getImage().bitmapData);					selectedBlockLand.visible = true;		}				private function setActionButton(actionButton:ActionButton, actionType:int) : void		{			switch(actionType)			{				case INFO:					actionButton.actionText.text = "Info";					break;				case MOVE:					actionButton.actionText.text = "Move";					break;				case ATTACK:					actionButton.actionText.text = "Attack";					break;				case CLAIM:					actionButton.actionText.text = "Claim";					break;				case BUILD:					actionButton.actionText.text = "Build";					break;				case TRAIN:					actionButton.actionText.text = "Train";					break;				case CRAFT:					actionButton.actionText.text = "Craft";					break;				case FORM:					actionButton.actionText.text = "Army";					break;				default:					actionButton.actionText.text = "Bug";			}								actionButton.actionType = actionType;			actionButton.visible = true;		}				private function hideActivateActionButtons() : void		{			button1.hideActivate();			button2.hideActivate();			button3.hideActivate();			button4.hideActivate();			button5.hideActivate();			button6.hideActivate();		}						private function hideSelectedBlocks() : void		{			selectedBlockArmy.visible = false;			selectedBlockCity.visible = false;			selectedBlockLand.visible = false;		}	}}