package ui {		import flash.display.MovieClip;	import game.entity.City;	import game.unit.Unit;	import flash.events.MouseEvent;	import game.entity.Entity;	import game.Game;			public class UnitsUI extends Panel 	{		public static var ICON_X_SPACER:int = 5;		public static var ICON_Y_SPACER:int = 5;		public static var ICON_X_START:int = 5;		public static var ICON_Y_START:int = 23;							public var city:City;		public var cityUI:CityUI;							private var iconUnits:Array;				public function UnitsUI() 		{			iconUnits = new Array();				}				override public function showPanel() : void		{			trace("UnitsUi showPanel");			this.visible = true;			setUnits();		}				override public function hidePanel() : void		{				this.visible = false;			removeUnits();		}							public function setUnits() : void		{			removeUnits();						trace("city.units.length: " + city.units.length);						for(var i = 0; i < city.units.length; i++)			{				var unit:Unit = Unit(city.units[i]);				var iconUnit:IconUnit = new IconUnit();								iconUnit.setUnit(unit);				iconUnit.x = ICON_X_START + (i % 7) * (iconUnit.width + ICON_X_SPACER);				iconUnit.y = ICON_Y_START + int(i / 7) * (iconUnit.height + ICON_Y_SPACER);				iconUnit.anchorX = iconUnit.x;				iconUnit.anchorY = iconUnit.y;				iconUnit.addEventListener(MouseEvent.MOUSE_DOWN, mouseDown);				iconUnit.addEventListener(MouseEvent.MOUSE_UP, mouseUp);								addChild(iconUnit);								iconUnits.push(iconUnit);			}		}						private function removeUnits() : void		{			for(var i = 0; i < iconUnits.length; i++)			{				var iconUnit:IconUnit = iconUnits[i];								if(this.contains(iconUnit))						{											removeChild(iconUnit);				}			}						iconUnits = new Array();		}						private function mouseDown(e:MouseEvent) : void		{			trace("Mouse down");			this.parent.setChildIndex(this, this.parent.numChildren - 1);			var iconUnit:IconUnit = IconUnit(e.currentTarget);						iconUnit.anchorX = iconUnit.x;			iconUnit.anchorY = iconUnit.y;									iconUnit.dragging = true;									iconUnit.parent.setChildIndex(iconUnit, iconUnit.parent.numChildren - 1);					iconUnit.startDrag();									e.stopPropagation();		}						private function mouseUp(e:MouseEvent) : void		{			trace("Mouse Up");			this.parent.setChildIndex(this, this.parent.numChildren - 1);				e.stopPropagation();						var iconUnit:IconUnit = IconUnit(e.currentTarget);						iconUnit.stopDrag()				iconUnit.dragging = false;						iconUnit.x = iconUnit.anchorX;			iconUnit.y = iconUnit.anchorY;							if(!this.parent.contains(iconUnit.dropTarget))			{				trace("iconUnit.dropTarget: " + iconUnit.dropTarget);								var parameters:Object = {unitId: iconUnit.unit.id,										 sourceId: city.id,										 sourceType: Entity.CITY,										 sourceUI: this,										 targetUI: iconUnit.dropTarget};								var pEvent:ParamEvent = new ParamEvent(Game.transferUnitEvent);				pEvent.params = parameters;					Game.INSTANCE.dispatchEvent(pEvent);			}		}					}	}